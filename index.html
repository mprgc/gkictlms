<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Static User Authentication</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; }
  /* Utility class to hide elements visually and structurally */
  .hidden-strict {
    display: none !important;
  }
  .auth-label-visible {
    opacity: 1;
    visibility: visible;
    height: auto;
    margin-bottom: 0.5rem; /* mb-2 */
    transition: opacity 0.3s ease-in-out, height 0.3s ease-in-out;
  }
  /* Custom height for input elements for maximum compactness */
  #authForm input[type="text"], 
  #authForm input[type="password"],
  #authForm input[type="tel"],
  #authForm select {
      padding: 0.5rem; /* p-2 */
  }
</style>
</head>
<!-- Main Body: Centering the content -->
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

<!-- Main Application Container -->
<div id="appContainer" class="w-full max-w-sm">

    <!-- Auth Form Container (Always visible until redirected) -->
    <div id="authContainer" class="bg-white p-4 rounded-xl shadow-xl border border-gray-200 w-full">
        
        <!-- Title: Smaller text and margin -->
        <h2 id="authTitle" class="text-lg font-bold text-gray-800 mb-2 text-center">
          Access Account
        </h2>

        <!-- Tabs: Smaller spacing and padding -->
        <div class="tabs flex space-x-1 p-0.5 bg-gray-100 rounded-lg mb-3">
          <button class="tab flex-1 py-1.5 px-3 rounded-lg text-sm font-semibold text-gray-600 transition duration-150" data-mode="login">Login</button>
          <button class="tab flex-1 py-1.5 px-3 rounded-lg text-sm font-semibold text-gray-600 transition duration-150" data-mode="register">Register</button>
        </div>

        <form id="authForm">
          
          <!-- START: Full Name Input (MOVED to be first, visibility controlled by JS) -->
          <label class="block auth-label-visible" id="fullNameLabel">
            <span class="text-xs font-medium text-gray-700">Full Name (සම්පූර්ණ නම)</span>
            <input type="text" id="authFullname" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Enter your full name"/>
          </label>
          
          <!-- PRIMARY IDENTIFIER: WhatsApp Number Input (Positioned second) -->
          <label class="block mb-2">
            <!-- Label: text-xs for maximum compactness -->
            <span class="text-xs font-medium text-gray-700">WhatsApp Number (වට්සැප් අංකය)</span>
            <input type="tel" id="authIdentifier" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="e.g., 0712345678"/>
          </label>

          <!-- START: Registration Extra Fields Container - Hidden in Login Mode (Full Name Removed) -->
          <div id="extraRegFields" class="hidden-strict">
              
              <!-- COMBINED: Grade and Institute using grid for horizontal arrangement -->
              <div class="grid grid-cols-2 gap-2 mb-2">
                  
                  <!-- Grade Input (Now taking half width) -->
                  <label class="block">
                    <span class="text-xs font-medium text-gray-700">Grade (ශ්‍රේණිය)</span>
                    <input type="text" id="authGrade" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="e.g., 10 or A/L"/>
                  </label>
                  
                  <!-- Institute Dropdown (Now taking half width) -->
                  <label class="block">
                    <span class="text-xs font-medium text-gray-700">Institute (ආයතනය)</span>
                    <select id="authClass" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors bg-white" required>
                        <option value="" disabled selected>-Select-</option>
                        <option value="සජීවා කොස්ගම">සජීවා කොස්ගම </option>
                        <option value="සිප්වන් කොට්ටාව">සිප්වන් කොට්ටාව </option>
                        <option value="ඉරැස්මා පාදුක්ක">ඉරැස්මා පාදුක්ක </option>
                        <option value="ශ්‍රී සුමන අවිස්සාවේල්ල">ශ්‍රී සුමන අවිස්සාවේල්ල </option>
                    </select>
                  </label>
              </div>
              <!-- END COMBINED -->

          </div>
          <!-- END: Registration Extra Fields Container -->

          <!-- Password Input -->
          <label class="block mb-2">
            <span class="text-xs font-medium text-gray-700">Password (මුරපදය)</span>
            <input type="password" id="authPassword" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="••••••••"/>
          </label>

          <!-- Submit Row -->
          <div class="flex flex-col items-center justify-end mb-1">
            
            <!-- Submit Button -->
            <button type="submit" id="authSubmit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-xl hover:bg-blue-700 transition duration-200 shadow-lg transform hover:-translate-y-0.5 text-sm">
              Login
            </button>
            
            <!-- Clear Saved Data Link - Visible only in Register Mode if data exists -->
            <button type="button" id="clearSavedBtnForm" class="hidden-strict text-red-600 hover:text-red-700 text-xs font-semibold underline bg-transparent border-none p-0 mt-2">
              Clear Saved Credentials
            </button>
            
          </div>

          <!-- Message Area -->
          <p id="authMessage" class="message text-center text-xs font-medium min-h-[20px] pt-2"></p>
        </form>
    </div>
</div>

<script>
(async function(){
  // --- Utility Functions ---
  function $id(id){ return document.getElementById(id); }
  
  function setMsg(txt, ok=false){
    const el = $id('authMessage');
    el.textContent = txt;
    el.className = 'message text-center text-xs font-medium min-h-[20px] pt-2'; // Reset classes
    if (txt) {
      if(ok){
        el.classList.add('text-green-700', 'bg-green-100', 'py-1', 'rounded-lg');
      } else {
        el.classList.add('text-red-700', 'bg-red-100', 'py-1', 'rounded-lg');
      }
    }
  }

  // Uses Web Crypto API for secure hashing
  async function hashPassword(pass){
    const data = new TextEncoder().encode(pass);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2,'0')).join('');
  }
  
  // --- Constants and Elements ---
  const KEY_USER = 'app_whatsapp_id'; 
  const KEY_PASS = 'app_password_hash';
  const KEY_LOGGED = 'app_logged';
  const KEY_REGISTERED = 'alreadyRegistered';
  
  const KEY_FULL_NAME = 'reg_fullname';
  const KEY_GRADE = 'reg_grade';
  const KEY_CLASS = 'reg_class'; // Stores the selected Institute

  const form = $id('authForm');
  const inputIdentifier = $id('authIdentifier');
  const inputPass = $id('authPassword');
  
  const inputFullname = $id('authFullname');
  const inputGrade = $id('authGrade');
  const inputClass = $id('authClass');
  
  const extraRegFieldsContainer = $id('extraRegFields');
  const fullNameLabel = $id('fullNameLabel');
  
  const submitBtn = $id('authSubmit');
  const tabs = document.querySelectorAll('.tab');
  
  const authContainer = $id('authContainer'); // Reference to the form container
  const clearSavedBtnForm = $id('clearSavedBtnForm'); 
  
  let mode = "login"; // State to track current mode

  // Function to set the current authentication mode (Login/Register)
  function setMode(newMode) {
    mode = newMode;
    
    // 1. Deactivate all tabs
    tabs.forEach(x => {
      x.classList.remove('bg-white', 'text-blue-600', 'shadow-md'); 
      x.classList.add('bg-gray-100', 'text-gray-600');
    });
    
    // 2. Activate the target tab
    const activeTab = document.querySelector(`.tab[data-mode="${mode}"]`);
    if (activeTab) {
      activeTab.classList.add('bg-white', 'text-blue-600', 'shadow-md');
      activeTab.classList.remove('bg-gray-100', 'text-gray-600');
    }

    // 3. Update button text and tab label 
    const regFlag = localStorage.getItem(KEY_REGISTERED);
    const registerTab = document.querySelector(`.tab[data-mode="register"]`);
    
    if (regFlag === "1") {
      registerTab.textContent = "Reset Account";
    } else {
      registerTab.textContent = "Register";
    }

    submitBtn.textContent = (mode === 'login') ? 'Login' : registerTab.textContent;
    setMsg(''); // Clear messages on mode switch
    
    // 4. Show/Hide fields and the Clear link based on mode
    if (extraRegFieldsContainer && fullNameLabel) {
      if (mode === 'register') {
        extraRegFieldsContainer.classList.remove('hidden-strict');
        fullNameLabel.classList.remove('hidden');
        fullNameLabel.classList.add('auth-label-visible');
        
        // Show form link if data is saved (Only in Register Mode)
        if (localStorage.getItem(KEY_USER)) {
            clearSavedBtnForm.classList.remove('hidden-strict');
        }
      } else {
        extraRegFieldsContainer.classList.add('hidden-strict');
        fullNameLabel.classList.add('hidden');
        fullNameLabel.classList.remove('auth-label-visible');
        
        // Hide form link in login mode
        clearSavedBtnForm.classList.add('hidden-strict');
      }
    }
  }

  // --- Clear Saved Data Handler ---
  function handleClearSavedData() {
    localStorage.removeItem(KEY_USER);
    localStorage.removeItem(KEY_PASS);
    localStorage.removeItem(KEY_LOGGED);
    localStorage.removeItem(KEY_REGISTERED);
    
    localStorage.removeItem(KEY_FULL_NAME);
    localStorage.removeItem(KEY_GRADE);
    localStorage.removeItem(KEY_CLASS);
    
    // Reset inputs
    inputIdentifier.value = ""; 
    inputPass.value = "";
    inputFullname.value = "";
    inputGrade.value = "";
    inputClass.value = ""; 
    
    // HIDE the form clear link immediately
    clearSavedBtnForm.classList.add('hidden-strict');
    
    // Re-initialize UI to show Register mode
    init(); 
    setMsg("All saved credentials cleared.", true);
  }


  // --- Event Listeners ---

  // Tab Switching Logic
  tabs.forEach(t => t.addEventListener('click', ()=>{
    setMode(t.dataset.mode);
  }));

  // Clear Saved Data - Attach handler to the form button only
  clearSavedBtnForm.addEventListener('click', handleClearSavedData);

  // Form Submission Handler
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = (mode === 'login') ? 'Logging in...' : 'Registering...';

    // u is the WhatsApp Number
    const u = inputIdentifier.value.trim(); 
    const p = inputPass.value;

    if(!u || !p){
      setMsg("Please enter both WhatsApp number and password.");
      submitBtn.disabled = false;
      submitBtn.textContent = (mode === 'login') ? 'Login' : 'Register';
      return;
    }
    
    const hash = await hashPassword(p);

    if(mode === "register"){
      // Registration Logic
      if (!inputClass.value) {
        setMsg("Please select an Institute (ආයතනයක් තෝරන්න).");
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register';
        return;
      }
      
      localStorage.setItem(KEY_USER, u);
      localStorage.setItem(KEY_PASS, hash);
      localStorage.setItem(KEY_REGISTERED, "1");
      localStorage.setItem(KEY_LOGGED, "true");
      
      localStorage.setItem(KEY_FULL_NAME, inputFullname.value.trim());
      localStorage.setItem(KEY_GRADE, inputGrade.value.trim());
      localStorage.setItem(KEY_CLASS, inputClass.value.trim());

      setMsg("Registration successful! Redirecting...", true);
      
      // Immediately redirect on success
      setTimeout(() => onLoginSuccess(u), 500);
      
    } else {
      // Login Logic
      const savedUser = localStorage.getItem(KEY_USER);
      const savedPass = localStorage.getItem(KEY_PASS);

      if(!savedUser){
        setMsg("No registered account found for this WhatsApp number. Please switch to Register tab.");
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
        return;
      }
      
      if(savedUser === u && savedPass === hash){
        // Success
        localStorage.setItem(KEY_LOGGED, "true");
        setMsg("Login successful! Redirecting...", true);
        setTimeout(() => onLoginSuccess(u), 500);
      } else {
        // Failure
        setMsg("Invalid WhatsApp number or password.");
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      }
    }
  });

  // --- Success Handler ---
  function onLoginSuccess(identifier){
    
    // Clear password input after success for security
    inputPass.value = '';
    authContainer.classList.add('hidden-strict'); // Hide the form right before redirecting
    
    // REDIRECTION LOGIC (This happens immediately)
    const REDIRECT_URL = "index_si.html"; // වෙනත් වෙබ් පිටුවකට යොමු කිරීමේ URL එක
    const fullName = localStorage.getItem(KEY_FULL_NAME) || identifier; 

    console.log(`Login successful for ${fullName}. Redirecting to ${REDIRECT_URL}...`);
    window.location.href = REDIRECT_URL;
  }

  // --- Initialization ---
  function init(){
    const savedIdentifier = localStorage.getItem(KEY_USER);
    const regFlag = localStorage.getItem(KEY_REGISTERED);
    // Removed the check for isLoggedIn and immediate redirect,
    // ensuring the form is always visible on page load as requested.

    // If not logged in, proceed to initialize the Auth Form (always visible now)
    authContainer.classList.remove('hidden-strict');

    // Set initial mode based on registration status 
    let initialMode = (regFlag === "1") ? 'login' : 'register';
    setMode(initialMode); 
    
    // Pre-fill fields if saved 
    if(savedIdentifier){
      inputIdentifier.value = savedIdentifier;
      inputFullname.value = localStorage.getItem(KEY_FULL_NAME) || "";
      inputGrade.value = localStorage.getItem(KEY_GRADE) || "";
      inputClass.value = localStorage.getItem(KEY_CLASS) || ""; 
    } else {
      inputIdentifier.value = "";
      inputFullname.value = "";
      inputGrade.value = "";
      inputClass.value = "";
    }
    
    inputPass.value = ""; // Always clear password on load

    // Control visibility of Clear Saved Data link 
    // This check is handled in setMode, but running it here ensures correct initial state.
    if (savedIdentifier && mode === 'register') {
      clearSavedBtnForm.classList.remove('hidden-strict');
    } else {
      clearSavedBtnForm.classList.add('hidden-strict');
    }

    submitBtn.disabled = false;
  }
  
  // Run initialization
  init();

})();
</script>

</body>
</html>
