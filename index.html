<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Account</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* This class is referenced by the JS for strict hiding/showing */
        .hidden-strict {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Auth Container -->
    <!-- CHANGED: Reduced vertical padding from p-6/p-8 to p-5/p-6 -->
    <div id="authContainer" class="w-full max-w-sm bg-white rounded-xl shadow-2xl p-5 md:p-6">
        
        <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Access Account</h2>

        <!-- Tabs Container -->
        <div class="flex p-1 bg-gray-100 rounded-lg mb-6">
            <button data-mode="login" class="tab w-1/2 py-2 text-sm font-semibold rounded-lg transition-all duration-300" id="loginTab">
                Login
            </button>
            <button data-mode="register" class="tab w-1/2 py-2 text-sm font-semibold rounded-lg transition-all duration-300" id="registerTab">
                Register
            </button>
        </div>

        <!-- Form and Message Container -->
        <!-- CHANGED: Reduced vertical space between elements from space-y-4 to space-y-3 -->
        <form id="authForm" class="space-y-3">

            <!-- Full Name (Only for Register Mode) -->
            <div id="fullNameLabel" class="space-y-1">
                <label for="authFullname" class="block text-sm font-medium text-gray-700">Full Name (සම්පූර්ණ නම)</label>
                <input type="text" id="authFullname" placeholder="Enter your full name" 
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base" />
            </div>

            <!-- WhatsApp Number (Identifier for both) -->
            <div class="space-y-1">
                <label for="authIdentifier" class="block text-sm font-medium text-gray-700">WhatsApp Number (වට්සැප් අංකය)</label>
                <input type="tel" id="authIdentifier" placeholder="e.g., 0712345678" 
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base" />
            </div>

            <!-- Registration-Specific Fields (Gradecle and Institute) -->
            <div id="extraRegFields" class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label for="authGrade" class="block text-sm font-medium text-gray-700">Grade (ශ්‍රේණිය)</label>
                    <input type="text" id="authGrade" placeholder="e.g., 10 or A/L" 
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base" />
                </div>
                <div class="space-y-1">
                    <label for="authClass" class="block text-sm font-medium text-gray-700">Institute (ආයතනය)</label>
                    <select id="authClass" 
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base appearance-none">
                        <option value="">-Select-</option>
                        <option value="සජීවා කොස්ගම">සජීවා කොස්ගම </option>
                        <option value="සිප්වන් කොට්ටාව">සිප්වන් කොට්ටාව </option>
                        <option value="ඉරැස්මා පාදුක්ක">ඉරැස්මා පාදුක්ක </option>
                        <option value="ශ්‍රී සුමන අවිස්සාවේල්ල">ශ්‍රී සුමන අවිස්සාවේල්ල </option>
                        <option value="Online පන්ති">Online පන්ති </option>
                    </select>
                </div>
            </div>

            <!-- Password -->
            <div class="space-y-1">
                <label for="authPassword" class="block text-sm font-medium text-gray-700">Password (මුරපදය)</label>
                <input type="password" id="authPassword" placeholder="••••••••" 
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base" />
            </div>

            <!-- Submit Button (Login/Register) -->
            <!-- CHANGED: Reduced top margin from mt-6 to mt-4 -->
            <button type="submit" id="authSubmit"
                    class="w-full py-2.5 mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300">
                Register
            </button>
            
            <!-- Clear Saved Data Link (Only in Register Mode when data is present) -->
            <div class="mt-2 text-center">
                 <button type="button" id="clearSavedBtnForm" class="text-xs text-red-500 hover:text-red-700 hidden-strict">Clear saved credentials</button>
            </div>

            <!-- Message Area (Used by JS: setMsg) -->
            <!-- Adjusted spacing (pt-1) to appear right below the Clear button/link -->
            <div id="authMessage" class="message text-center text-xs font-medium min-h-[20px] pt-1"></div>

            
        </form>
    </div>


    <!-- JavaScript Logic -->
    <script>
        // The user-provided JS code for functionality
        (async function(){
            // --- Utility Functions ---
            function $id(id){ return document.getElementById(id); }
            
            function setMsg(txt, ok=false){
              const el = $id('authMessage');
              el.textContent = txt;
              // Updated class for positioning below the clear credentials link
              el.className = 'message text-center text-xs font-medium min-h-[20px] pt-1'; // Reset classes
              if (txt) {
                if(ok){
                  el.classList.add('text-green-700', 'bg-green-100', 'py-1', 'px-2', 'rounded-lg');
                } else {
                  el.classList.add('text-red-700', 'bg-red-100', 'py-1', 'px-2', 'rounded-lg');
                }
              }
            }

            // Uses Web Crypto API for secure hashing
            async function hashPassword(pass){
              const data = new TextEncoder().encode(pass);
              const hashBuffer = await crypto.subtle.digest('SHA-256', data);
              return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2,'0')).join('');
            }
            
            // --- Constants and Elements ---
            const KEY_USER = 'app_whatsapp_id'; 
            const KEY_PASS = 'app_password_hash';
            const KEY_LOGGED = 'app_logged';
            const KEY_REGISTERED = 'alreadyRegistered';
            
            const KEY_FULL_NAME = 'reg_fullname';
            const KEY_GRADE = 'reg_grade';
            const KEY_CLASS = 'reg_class'; // Stores the selected Institute

            const form = $id('authForm');
            const inputIdentifier = $id('authIdentifier');
            const inputPass = $id('authPassword');
            
            const inputFullname = $id('authFullname');
            const inputGrade = $id('authGrade');
            const inputClass = $id('authClass');
            
            const extraRegFieldsContainer = $id('extraRegFields');
            const fullNameLabel = $id('fullNameLabel');
            
            const submitBtn = $id('authSubmit');
            const tabs = document.querySelectorAll('.tab');
            const clearSavedBtnForm = $id('clearSavedBtnForm'); 
            
            let mode = "login"; // State to track current mode

            // Function to set the current authentication mode (Login/Register)
            function setMode(newMode) {
              mode = newMode;
              
              // 1. Deactivate all tabs and activate the current one
              tabs.forEach(x => {
                x.classList.remove('bg-white', 'text-blue-600', 'shadow-md'); 
                x.classList.add('bg-gray-100', 'text-gray-600');
              });
              
              const activeTab = document.querySelector(`.tab[data-mode="${mode}"]`);
              if (activeTab) {
                activeTab.classList.add('bg-white', 'text-blue-600', 'shadow-md');
                activeTab.classList.remove('bg-gray-100', 'text-gray-600');
              }

              // 2. Update button text and tab label 
              const regFlag = localStorage.getItem(KEY_REGISTERED);
              const registerTab = document.querySelector(`.tab[data-mode="register"]`);
              
              // Update Register tab label based on registration status
              if (regFlag === "1") {
                registerTab.textContent = "Reset Account";
              } else {
                registerTab.textContent = "Register";
              }

              submitBtn.textContent = (mode === 'login') ? 'Login' : registerTab.textContent;
              setMsg(''); // Clear messages on mode switch
              
              // 3. Show/Hide registration-specific fields (Full Name, Grade, Institute)
              if (mode === 'register') {
                // SHOW all registration fields
                extraRegFieldsContainer.classList.remove('hidden-strict');
                fullNameLabel.classList.remove('hidden-strict');
                
                // Show form link always when in Register Mode (as requested by user)
                clearSavedBtnForm.classList.remove('hidden-strict');

              } else {
                // HIDE all registration fields for login mode
                extraRegFieldsContainer.classList.add('hidden-strict'); // Hides Grade/Institute
                fullNameLabel.classList.add('hidden-strict'); // Hides Full Name
                
                // Hide form link in login mode
                clearSavedBtnForm.classList.add('hidden-strict');
              }
            }

            // --- Clear Saved Data Handler ---
            function handleClearSavedData() {
              localStorage.clear(); // Clears ALL stored keys
              
              // Reset inputs
              inputIdentifier.value = ""; 
              inputPass.value = "";
              inputFullname.value = "";
              inputGrade.value = "";
              inputClass.value = ""; 
              
              // HIDE the form clear link immediately
              clearSavedBtnForm.classList.add('hidden-strict');
              
              // CHANGED: Instead of calling init(), explicitly set mode to 'register' to prevent
              // switching to the 'login' UI after clearing credentials.
              setMode('register'); 
              
              setMsg("All saved credentials cleared.", true);
            }


            // --- Event Listeners ---

            // Tab Switching Logic
            tabs.forEach(t => t.addEventListener('click', ()=>{
              setMode(t.dataset.mode);
            }));

            // Clear Saved Data - Attach handler to the form button only
            clearSavedBtnForm.addEventListener('click', handleClearSavedData);

            // Form Submission Handler
            form.addEventListener('submit', async (ev)=>{
              ev.preventDefault();
              submitBtn.disabled = true;
              submitBtn.textContent = (mode === 'login') ? 'Logging in...' : 'Registering...';

              const u = inputIdentifier.value.trim(); 
              const p = inputPass.value;

              if(!u || !p){
                setMsg("Please enter both WhatsApp number and password.");
                submitBtn.disabled = false;
                submitBtn.textContent = (mode === 'login') ? 'Login' : 'Register';
                return;
              }
              
              const hash = await hashPassword(p);

              if(mode === "register"){
                // Registration Logic
                if (!inputClass.value) {
                  setMsg("Please select an Institute (ආයතනයක් තෝරන්න).");
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Register';
                  return;
                }
                
                // Save data
                localStorage.setItem(KEY_USER, u);
                localStorage.setItem(KEY_PASS, hash);
                localStorage.setItem(KEY_REGISTERED, "1");
                localStorage.setItem(KEY_LOGGED, "true");
                
                localStorage.setItem(KEY_FULL_NAME, inputFullname.value.trim());
                localStorage.setItem(KEY_GRADE, inputGrade.value.trim());
                localStorage.setItem(KEY_CLASS, inputClass.value.trim());

                setMsg("Registration successful! Redirecting...", true);
                
                setTimeout(() => onLoginSuccess(u), 500);
                
              } else {
                // Login Logic
                const savedUser = localStorage.getItem(KEY_USER);
                const savedPass = localStorage.getItem(KEY_PASS);

                if(!savedUser){
                  setMsg("No registered account found. Please switch to Register tab or use the correct WhatsApp number.");
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Login';
                  return;
                }
                
                if(savedUser === u && savedPass === hash){
                  // Success
                  localStorage.setItem(KEY_LOGGED, "true");
                  setMsg("Login successful! Redirecting...", true);
                  setTimeout(() => onLoginSuccess(u), 500);
                } else {
                  // Failure
                  setMsg("Invalid WhatsApp number or password.");
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Login';
                }
              }
            });

            // --- Success Handler ---
            function onLoginSuccess(identifier){
              
              // Clear password input after success for security
              inputPass.value = '';
              
              // Hide the form right before redirecting
              $id('authContainer').classList.add('hidden-strict'); 
              
              // REDIRECTION LOGIC
              const REDIRECT_URL = "index_si.html"; 
              console.log(`Login successful for ${identifier}. Redirecting to ${REDIRECT_URL}...`);
              window.location.href = REDIRECT_URL;
            }

            // --- Initialization ---
            function init(){
              const savedIdentifier = localStorage.getItem(KEY_USER);
              const regFlag = localStorage.getItem(KEY_REGISTERED);
              
              // MODIFIED: Force initial mode to 'login' to match the user's requested image state.
              let initialMode = 'login'; 
              
              // Note: The previous logic was: let initialMode = (regFlag === "1") ? 'login' : 'register';
              // The new logic prioritizes the visual state requested by the user's image.
              
              setMode(initialMode); 
              
              // Pre-fill fields if saved and set inputs to match saved data for current mode
              if(savedIdentifier){
                inputIdentifier.value = savedIdentifier;
                inputFullname.value = localStorage.getItem(KEY_FULL_NAME) || "";
                inputGrade.value = localStorage.getItem(KEY_GRADE) || "";
                // Ensure the select dropdown value is set correctly
                const savedClass = localStorage.getItem(KEY_CLASS) || "";
                const classOptions = Array.from(inputClass.options).map(opt => opt.value);
                if(classOptions.includes(savedClass)) {
                  inputClass.value = savedClass;
                } else {
                  inputClass.value = ""; // Default to select if value is missing/invalid
                }
              } else {
                // Clear all fields if no user is saved
                inputIdentifier.value = "";
                inputFullname.value = "";
                inputGrade.value = "";
                inputClass.value = "";
              }
              
              inputPass.value = ""; // Always clear password on load

              // Control visibility of Clear Saved Data link (Re-run setMode to ensure button visibility is correct)
              setMode(initialMode);
              submitBtn.disabled = false;
            }
            
            // Run initialization
            init();

        })();
    </script>

</body>
</html>
