<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>තොරතුරු තාක්ෂණ ප්‍රශ්නාවලිය</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas CDN for converting HTML to JPEG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Custom styles for Sinhala font and background */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 15px; /* Reduced overall padding */
            box-sizing: border-box;
            
            /* --- COPY PREVENTION (පාඨ පිටපත් කිරීම වැළැක්වීම) --- */
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
        }
        .quiz-card {
            max-width: 550px; /* Reduced max width slightly */
            width: 100%;
            background-color: white;
            padding: 1.25rem; /* Reduced padding */
            border-radius: 0.75rem; /* Slightly smaller border radius */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); /* Reduced shadow */
            margin-bottom: 15px;
        }
        
        @media (max-width: 640px) {
            /* Responsive adjustments for mobile font sizes */
            .quiz-card h1 {
                font-size: 1.35rem; /* Slightly smaller main title on mobile */
            }
            .question-text {
                font-size: 1.0rem; /* Smaller question text on mobile */
            }
        }

        .option-button {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            padding: 0.75rem; /* Reduced option button padding */
            font-size: 1.0rem; /* Kept option text size reasonable */
        }
        .option-button:hover:not(.disabled) {
            background-color: #e0f2f1; /* Light cyan on hover */
        }
        /* Specific colors for feedback */
        .correct-answer {
            background-color: #84cc16 !important; /* Lime 500 - Kolapata (Correct) */
            color: white !important;
            border-color: #65a30d !important;
        }
        .incorrect-answer {
            background-color: #ef4444 !important; /* Red 500 - Rathupata (Incorrect) */
            color: white !important;
            border-color: #dc2626 !important;
        }
        .disabled {
            pointer-events: none;
            opacity: 0.8;
        }
        /* Timer bar style */
        #timer-progress {
            transition: width 1s linear;
        }
        
        /* Modal Animation Styles */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-enter-animation {
            animation: modalFadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* Styles for the Capture Card (Made smaller and more compact) */
        #result-card-to-capture {
            background-color: #e0f7fa; /* Light cyan background for the certificate look */
            border: 3px solid #00bcd4; /* Slightly thinner border */
        }
        .logo-placeholder {
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>
<body>

<div class="quiz-card">
    <!-- Reduced H1 size from text-3xl to text-2xl -->
    <h1 class="text-2xl font-bold text-gray-800 mb-2 text-center">තොරතුරු තාක්ෂණ ප්‍රශ්නාවලිය</h1>
    <!-- Reduced text size from text-md to text-sm -->
    <p class="text-center text-sm text-blue-700 mb-6 font-semibold">GK ICT School අපි විභාග ලියන අලුත් විදිහ.</p>

    <!-- 1. START SCREEN -->
    <!-- Reduced padding and shadow -->
    <div id="start-screen" class="text-center p-5 bg-blue-50 rounded-lg shadow"> 
        <!-- Reduced H2 size from text-2xl to text-xl -->
        <h2 class="text-xl font-extrabold mb-4 text-blue-800">ප්‍රශ්නාවලිය ආරම්භ කිරීමට සූදානම්ද?</h2>
        
        <!-- Student Name Input -->
        <div class="mb-3 text-left">
            <!-- Reduced label size from text-sm to text-xs -->
            <label for="student-name" class="block text-xs font-medium text-gray-700 mb-1">ශිෂ්‍යයාගේ නම (Student Name):</label>
            <!-- Reduced input padding from p-3 to p-2.5 -->
            <input type="text" id="student-name" placeholder="ඔබේ සම්පුර්ණ නම ඇතුළත් කරන්න" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" required>
        </div>
        <!-- Student Class Input -->
        <div class="mb-4 text-left">
            <!-- Reduced label size from text-sm to text-xs -->
            <label for="student-class" class="block text-xs font-medium text-gray-700 mb-1">පන්තිය (Class):</label>
            <!-- Reduced input padding from p-3 to p-2.5 -->
            <input type="text" id="student-class" placeholder="උදා: 8 වසර සජීවා පන්තිය" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" required>
        </div>
        
        <!-- Reduced button padding and text size -->
        <button onclick="showInstructions()" class="w-full bg-gray-200 text-gray-700 py-1 text-sm rounded-lg hover:bg-gray-300 transition duration-300 mb-3 shadow-sm">
            උපදෙස් කියවන්න (Read Instructions)
        </button>
        
        <!-- Reduced button padding and text size from text-2xl to text-xl -->
        <button onclick="validateAndStartQuiz()" class="w-full bg-blue-600 text-white py-3 text-xl rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg transform hover:scale-[1.01]">
            Start Quiz
        </button>
        <!-- Reduced validation message size from text-sm to text-xs -->
        <p id="validation-message" class="text-red-600 mt-2 text-xs font-semibold hidden">නම සහ පන්තිය ඇතුළත් කිරීම අනිවාර්යයි! (Name and Class are required!)</p>
    </div>

    <!-- 2. TIMER DISPLAY -->
    <div id="timer-display" class="mb-3 text-center hidden">
        <div id="timer-bar" class="w-full h-1.5 bg-gray-200 rounded-full overflow-hidden"> <!-- Reduced height -->
            <div id="timer-progress" class="h-1.5 bg-red-500 transition-all duration-1000 ease-linear" style="width: 100%;"></div>
        </div>
        <!-- Reduced text size from text-sm to text-xs -->
        <p class="mt-1 text-xs text-gray-600 font-medium"><span id="time-left">40</span> තත්පර ඉතිරිව ඇත (Time Left)</p>
    </div>
    
    <!-- 3. QUIZ CONTAINER -->
    <div id="quiz-container" class="hidden">
        <!-- Question and options will be rendered here -->
    </div>
    
    <!-- 4. RESULTS CONTAINER -->
    <div id="results-container" class="hidden">
        
        <!-- Result Card to be captured by html2canvas -->
        <!-- Reduced padding from p-8 to p-5 -->
        <div id="result-card-to-capture" class="p-5 rounded-lg mb-4 shadow-xl"> 
            <!-- Reduced logo size from w-20 h-20 to w-16 h-16 -->
            <img 
                src="https://mprgc.github.io/gkictlms/Grade/01.png" 
                onerror="this.onerror=null;this.src='01.png'" 
                alt="GK ICT Logo" 
                class="logo-placeholder w-16 h-16 mx-auto mb-3"
            >
            <!-- Reduced H2 size from text-3xl to text-2xl -->
            <h2 class="text-2xl font-extrabold text-center mb-1 text-blue-900">ප්‍රශ්නාවලියේ අවසන් ප්‍රතිඵලය</h2>
            <!-- Reduced text size from text-lg to text-base, border-b padding reduced -->
            <p class="text-center text-base text-gray-700 mb-4 border-b pb-3 border-blue-400">GK ICT School - තොරතුරු තාක්ෂණ ප්‍රශ්නාවලිය</p>
            
            <!-- Student Info Display on Result Card -->
            <div class="mb-4 text-center">
                <!-- Reduced text size from text-xl to text-lg -->
                <p class="text-lg font-bold text-gray-800 mb-1">නම: <span id="display-student-name" class="font-extrabold text-blue-800">--</span></p>
                <!-- Reduced text size from text-md to text-sm -->
                <p class="text-sm font-semibold text-gray-600">පන්තිය: <span id="display-student-class" class="font-bold text-blue-700">--</span></p>
            </div>

            <!-- Detailed Score and Percentage Display -->
            <!-- Reduced text size from text-xl to text-lg -->
            <p id="correct-answers-count" class="text-lg font-bold text-center mb-2 text-gray-700"></p>
            <!-- Reduced text size from text-2xl to text-xl (This is the main score) -->
            <p id="final-percentage" class="text-3xl font-black text-center mb-3"></p>

            <!-- Reduced text size from text-sm to text-xs -->
            <p id="result-date" class="text-xs text-center text-gray-600">දිනය සහ වේලාව: --</p>
        </div>
        
        <!-- Action Buttons (outside the capture area) -->
        <!-- Reduced button padding and margin -->
        <button onclick="captureResultsAsImage()" class="w-full bg-green-600 text-white py-2.5 rounded-lg hover:bg-green-700 transition duration-300 mb-3 shadow-md transform hover:scale-[1.02]">
            ප්‍රතිඵල ලේඛනය බාගත කරන්න (JPEG)
        </button>
        
        <!-- Reduced button padding -->
        <button onclick="resetQuizState()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 transition duration-300">
            නැවත මුලට යන්න (Go to Start)
        </button>
    </div>
</div>

<!-- 5. INSTRUCTION MODAL (POPUP MENU) -->
<div id="instruction-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
    <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-5 m-4 max-w-sm sm:max-w-md w-full max-h-[90vh] overflow-y-auto">
        <!-- Reduced H3 size from text-2xl to text-xl -->
        <h3 class="text-xl font-bold text-blue-700 mb-3 border-b pb-1.5">ප්‍රශ්නාවලියේ උපදෙස්</h3>
        
        <!-- Reduced text size from text-base to text-sm -->
        <ul class="text-left text-gray-700 space-y-2 list-disc list-inside mb-4 text-sm">
            <li>සියලුම ප්‍රශ්න සඳහා පිළිතුරු දියයුතුය.</li>
            <li>සෑම ප්‍රශ්නයක් සඳහාම පිළිතුරු දීමට ඔබට තත්පර 40ක කාලයක් ලැබේ.</li>
            <li>නියමිත කාලය තුළ පිළිතුරු ලබා දීමට නොහැකි වුවහොත් එය අවසන් ලකුණු වලට එකතු වන්නේ නැත.</li>
            <li>**ආරක්ෂක නීති (Security Rules):**
                <ul class="list-disc list-inside ml-4 mt-1 space-y-0.5 text-xs text-red-600 font-medium"> <!-- Reduced nested list size -->
                    <li>right-click කිරීම සහ mobile long press කිරීම අවහිර කර ඇත.</li>
                    <li>වෙනත් Tab එකකට හෝ Window එකකට මාරු වුවහොත් ප්‍රශ්නාවලිය **නැවත මුල සිටම ආරම්භ වේ**.</li>
                    <li>Developer Tools විවෘත කිරීමේ කෙටිමං අවහිර කර ඇත.</li>
                </ul>
            </li>
        </ul>
        
        <!-- Reduced button padding -->
        <button onclick="hideInstructions()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">
            තේරුම් ගත්තා (Got It)
        </button>
    </div>
</div>

<script>
    // ----------------------------------------------------------------------
    // [SECURITY ENHANCEMENTS - ආරක්ෂක වැඩි දියුණු කිරීම්]
    // ----------------------------------------------------------------------

    // --- 2. F12, Ctrl/Cmd + Shortcuts PREVENTION (කෙටිමං අවහිර කිරීම) ---
    document.addEventListener('keydown', function (e) {
        // F12 key (e.key === 'F12' or e.keyCode === 123)
        /*if (e.key === 'F12' || e.keyCode === 123) {
            e.preventDefault();
        }*/
        
        // Ctrl+Shift+I, Ctrl+Shift+J (Windows/Linux) - Developer Tools
        if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) {
            e.preventDefault();
        }
        
        // Ctrl+U (Windows/Linux) - View Source
        if (e.ctrlKey && e.key === 'U') {
            e.preventDefault();
        }

        // Cmd+Option+I (Mac) - Developer Tools
        if (e.metaKey && e.altKey && e.key === 'I') {
            e.preventDefault();
        }
        
        // Cmd+Option+J (Mac) - Developer Tools
        if (e.metaKey && e.altKey && e.key === 'J') {
            e.preventDefault();
        }
    });

    // --- 3. RIGHT CLICK AND LONG PRESS PREVENTION (Right Click සහ Long Press වැළැක්වීම) ---
    document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
    });
    
    // ----------------------------------------------------------------------
    // [QUIZ LOGIC - ප්‍රශ්නාවලියේ කේතය]
    // ----------------------------------------------------------------------
    
    // Constants for the quiz
    const TIME_LIMIT = 40; // Time in seconds for each question
    
    // Global variables
    let currentQuestionIndex = 0;
    let score = 0;
    let isQuestionLocked = false;
    let timeRemaining = TIME_LIMIT;
    let timerInterval;

    // NEW: Global variables for student info
    let studentName = '';
    let studentClass = '';

    // DOM elements
    const startScreen = document.getElementById('start-screen');
    const quizContainer = document.getElementById('quiz-container');
    const resultsContainer = document.getElementById('results-container');
    const timerDisplay = document.getElementById('timer-display');
    const instructionModal = document.getElementById('instruction-modal'); // MODAL CONTAINER
    const modalContent = document.getElementById('modal-content'); // MODAL CONTENT DIV (for animation)

    // ----------------------------------------------------------------------
    // [MODAL FUNCTIONS - Popup Menu ක්‍රියාකාරීත්වය]
    // ----------------------------------------------------------------------

    function showInstructions() {
        instructionModal.classList.remove('hidden');
        // Add animation class when showing the modal
        modalContent.classList.add('modal-enter-animation');
    }

    function hideInstructions() {
        // Remove animation class and hide the modal
        instructionModal.classList.add('hidden');
        modalContent.classList.remove('modal-enter-animation');
    }

    // ----------------------------------------------------------------------
    // [STUDENT INFO VALIDATION]
    // ----------------------------------------------------------------------
    
    function validateAndStartQuiz() {
        const nameInput = document.getElementById('student-name');
        const classInput = document.getElementById('student-class');
        const validationMessage = document.getElementById('validation-message');

        studentName = nameInput.value.trim();
        studentClass = classInput.value.trim();

        if (studentName === '' || studentClass === '') {
            validationMessage.classList.remove('hidden');
            // Shake effect for attention (optional)
            nameInput.classList.add('ring-2', 'ring-red-500');
            classInput.classList.add('ring-2', 'ring-red-500');
            setTimeout(() => {
                nameInput.classList.remove('ring-2', 'ring-red-500');
                classInput.classList.remove('ring-2', 'ring-red-500');
            }, 500);
            return;
        }

        validationMessage.classList.add('hidden');
        startQuiz(); // Proceed to start the quiz
    }

    // ----------------------------------------------------------------------
    // [ප්‍රශ්නාවලියේ දත්ත / QUIZ DATA SECTION]
    // ----------------------------------------------------------------------
    const quizData = [
        // Q1
        { question: "URL යන්නෙහි දිගු ස්වරූපය කුමක්ද?", correct: "Uniform Resource Locator.", distractors: ["Universal Record Linkage.", "Uniform Redirect Language."] },
        // Q2
        { question: "වීඩියෝ සම්මන්ත්‍රණ (video conferencing) සඳහා භාවිතා කරන මෘදුකාංග සඳහා උදාහරණ දෙකක් දෙන්න.", correct: "Zoom, Skype, GoToMeeting, Webex.", distractors: ["Microsoft Word, Excel.", "Adobe Photoshop, Illustrator."] },
        // Q3
        { question: "විද්‍යුත් තැපෑලක (e-mail) ලැබුණු පණිවිඩයක් වෙනත් අයෙකුට යැවීම හැඳින්වෙන්නේ කුමන නමකින්ද?", correct: "Forward කිරීම.", distractors: ["Reply කිරීම.", "Cc කිරීම."] },
        // Q4
        { question: "විද්‍යුත් තැපෑලක් සමඟ ගොනු (files) යැවීමේ ක්‍රියාවලිය කුමක්ද?", correct: "Attach කිරීම.", distractors: ["Download කිරීම.", "Upload කිරීම."] },
        // Q5
        { question: "විද්‍යුත් තැපෑලක 'To' ක්ෂේත්‍රයේ යොදනු ලබන්නේ කුමක්ද?", correct: "පණිවිඩයේ ප්‍රධාන ලබන්නාගේ විද්‍යුත් තැපැල් ලිපිනය.", distractors: ["පණිවිඩයේ සාරාංශය.", "පණිවිඩයේ පිටපතක් යවන අයගේ ලිපිනය."] },
        // Q6
        { question: "විද්‍යුත් තැපෑලක 'Cc' යන්නෙහි තේරුම කුමක්ද?", correct: "Carbon Copy, එනම් පණිවිඩයේ පිටපතක් යවන අනෙකුත් ලබන්නන්.", distractors: ["Confidential Copy, එනම් රහස් පිටපතක්.", "Communication Center."] },
        // Q7
        { question: "විද්‍යුත් තැපෑලක 'Bcc' යන්නෙහි තේරුම සහ එහි විශේෂත්වය කුමක්ද?", correct: "Blind Carbon Copy, මෙහි යොදන ලබන්නන්ව 'To' හෝ 'Cc' හි සිටින අනෙක් අයට නොපෙනේ.", distractors: ["Basic Copy, සියලුම ලබන්නන්ට පෙනේ.", "Business Communication Center."] },
        // Q8
        { question: "විද්‍යුත් තැපෑලක 'Subject' ක්ෂේත්‍රයේ ඇතුළත් කළ යුත්තේ කුමක්ද?", correct: "පණිවිඩයේ අන්තර්ගතය පිළිබඳ සාරාංශයක්.", distractors: ["ප්‍රධාන ලබන්නාගේ ලිපිනය.", "අදාල ගොනු (Attachments) වල නම්."] },
        // Q9
        { question: "www යන්නෙන් අදහස් කරන්නේ කුමක්ද?", correct: "ලෝක ව්‍යාප්ත ජාලය (world wide web).", distractors: ["ව්‍යාපාරික වෙබ් අඩවි ජාලය (World Wide Websites)", "පුළුල් ප්‍රදේශ ජාලය (Wide Area Network)"] },
        // Q10
        { question: "පුද්ගලයෙකුට අන්තර්ජාලය ඔස්සේ අපහාස කිරීම, තර්ජනය කිරීම හෝ අපහසුතාවයට පත් කිරීම හඳුන්වන්නේ කෙසේද?", correct: "සයිබර් හිරිහැර කිරීම (cyberbullying).", distractors: ["ෆිෂින් (phishing).", "හැකින් (hacking)."] },
        
    ];

    // Array Shuffle Function (Fisher-Yates) - ප්‍රශ්න සහ පිළිතුරු අහඹු ලෙස පෙළගැස්වීම සඳහා
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            // Correct destructuring swap
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Handles the quiz when the time for a question runs out
    function handleTimeout() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        if (isQuestionLocked) return; 
        isQuestionLocked = true;

        const optionsList = document.getElementById('options-list');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextButton = document.getElementById('next-button');
        const currentQ = quizData[currentQuestionIndex];
        
        // Show the correct answer (color it green)
        if (optionsList) {
            Array.from(optionsList.children).forEach(button => {
                const answer = button.getAttribute('data-answer');
                if (answer === currentQ.correct) {
                    button.classList.add('correct-answer');
                } else {
                    button.classList.add('disabled', 'opacity-50');
                }
            });
        }
        
        // Show feedback message for timeout
        if (feedbackMessage) {
            feedbackMessage.textContent = 'කාලය අවසන්! පිළිතුරක් තේරුවේ නැත. (Time\'s up! No answer selected.)';
            feedbackMessage.classList.remove('hidden', 'text-lime-600');
            feedbackMessage.classList.add('text-red-500');
        }
        
        // Enable Next button
        if (nextButton) {
            nextButton.disabled = false;
            nextButton.classList.remove('bg-gray-400', 'disabled');
            nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }
    }

    // Starts the timer for the current question
    function startTimer() {
        // Clear any existing timer
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        timeRemaining = TIME_LIMIT;
        const timeLeftElement = document.getElementById('time-left');
        const timerProgressElement = document.getElementById('timer-progress');

        // Update display immediately and set bar to 100%
        if (timeLeftElement) timeLeftElement.textContent = timeRemaining;
        if (timerProgressElement) {
            timerProgressElement.style.width = '100%';
            timerProgressElement.classList.remove('bg-red-700');
            timerProgressElement.classList.add('bg-red-500');
        }
        
        // Start countdown
        timerInterval = setInterval(() => {
            timeRemaining--;

            // Update time display
            if (timeLeftElement) timeLeftElement.textContent = timeRemaining;
            
            // Update progress bar
            const progress = (timeRemaining / TIME_LIMIT) * 100;
            if (timerProgressElement) timerProgressElement.style.width = `${progress}%`;

            // Change bar color when time is low
            if (timeRemaining <= 5 && timerProgressElement) {
                // Flash effect for low time (optional)
                timerProgressElement.classList.toggle('bg-red-700');
            }

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                handleTimeout();
            }
        }, 1000);
    }

    // ප්‍රශ්නය සහ පිළිතුරු විදැහුම් කිරීමේ කාර්යය
    function renderQuestion() {
        if (currentQuestionIndex >= quizData.length) {
            showResults();
            return;
        }

        isQuestionLocked = false;
        const currentQ = quizData[currentQuestionIndex];
        
        // නිවැරදි පිළිතුර සහ වැරදි පිළිතුරු එකතු කර අහඹු ලෙස පෙළගැස්වීම
        const options = shuffleArray([
            currentQ.correct, 
            ...currentQ.distractors.slice(0, 3) 
        ]);

        const totalQuestions = quizData.length; // මුළු ප්‍රශ්න ගණන (10)
        const questionNumber = currentQuestionIndex + 1;
        

        quizContainer.innerHTML = `
            <div class="mb-4"> <!-- Reduced margin -->
                <!-- Reduced text size from text-lg to text-base -->
                <p class="text-base font-semibold text-cyan-700 mb-2">ප්‍රශ්නය ${questionNumber} / ${totalQuestions}</p>
                <!-- Reduced text size from text-xl to text-lg -->
                <h2 class="question-text text-lg font-bold text-gray-700">${currentQ.question}</h2>
            </div>
            <div id="options-list" class="space-y-2"> <!-- Reduced space -->
                ${options.map((option, index) => `
                    <button 
                        class="option-button w-full text-left p-3 border border-gray-300 rounded-lg text-gray-700 shadow-sm transition duration-150 ease-in-out bg-gray-50 text-base"
                        data-answer="${option}"
                        onclick="checkAnswer(this, '${currentQ.correct.replace(/'/g, "\\'")}')"
                    >
                        ${option}
                    </button>
                `).join('')}
            </div>
            <div id="feedback-message" class="mt-3 text-center text-sm font-medium hidden"></div> <!-- Reduced margin -->
            <button id="next-button" onclick="nextQuestion()" class="mt-4 w-full bg-gray-400 text-white py-2.5 rounded-lg disabled transition duration-300" disabled> <!-- Reduced margin and padding -->
                ඊළඟ ප්‍රශ්නය (Next Question)
            </button>
        `;
        
        // Start the timer for the new question
        startTimer();
    }

    // පිළිතුර පරීක්ෂා කිරීමේ කාර්යය
    function checkAnswer(selectedButton, correctAnswer) {
        if (isQuestionLocked) return;
        
        // Stop the timer immediately
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        isQuestionLocked = true;

        const selectedAnswer = selectedButton.getAttribute('data-answer');
        const optionsList = document.getElementById('options-list').children;
        const feedbackMessage = document.getElementById('feedback-message');
        const nextButton = document.getElementById('next-button');
        let isCorrect = false;

        // සියලුම බොත්තම් disable කිරීම
        Array.from(optionsList).forEach(button => {
            button.classList.add('disabled');
        });
        
        // නිවැරදි පිළිතුර සොයාගෙන වර්ණ ගැන්වීම
        Array.from(optionsList).forEach(button => {
            const answer = button.getAttribute('data-answer');
            if (answer === correctAnswer) {
                button.classList.add('correct-answer');
                if (button === selectedButton) {
                    isCorrect = true;
                }
            }
        });

        if (isCorrect) {
            score++;
            selectedButton.classList.add('correct-answer'); // කොළ පාට
            feedbackMessage.textContent = 'නිවැරදියි! (Correct!)';
            feedbackMessage.classList.remove('text-red-500', 'hidden');
            feedbackMessage.classList.add('text-lime-600');
        } else {
            selectedButton.classList.add('incorrect-answer'); // රතු පාට
            feedbackMessage.textContent = 'වැරදියි! නිවැරදි පිළිතුර කොළ පැහැයෙන් දක්වා ඇත. (Incorrect!)';
            feedbackMessage.classList.remove('text-lime-600', 'hidden');
            feedbackMessage.classList.add('text-red-500');
        }

        // Next බොත්තම සක්‍රිය කිරීම
        nextButton.disabled = false;
        nextButton.classList.remove('bg-gray-400', 'disabled');
        nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }

    // ඊළඟ ප්‍රශ්නයට යාමේ කාර්යය
    function nextQuestion() {
        currentQuestionIndex++;
        renderQuestion();
    }

    // ප්‍රතිඵල රූපයක් ලෙස බාගත කිරීමේ කාර්යය
    function captureResultsAsImage() {
        const card = document.getElementById('result-card-to-capture');
        
        // Use html2canvas to capture the content
        html2canvas(card, {
            scale: 2, // Increase scale for higher resolution
            allowTaint: true, 
            useCORS: true 
        }).then(canvas => {
            // Convert canvas to JPEG Data URL
            const imageUrl = canvas.toDataURL('image/jpeg', 0.9); // 0.9 quality
            
            // Create a temporary link element for download
            const link = document.createElement('a');
            const date = new Date().toLocaleDateString('si-LK');
            link.download = `ICT_Quiz_Scorecard_${studentName}_${date}.jpeg`; // Updated filename
            link.href = imageUrl;
            
            // Trigger the download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }).catch(error => {
            console.error('HTML to Canvas conversion failed:', error);
            // Error handling
        });
    }

    // ප්‍රතිඵල පෙන්වීමේ කාර්යය
    function showResults() {
        // Clear the timer when results are shown
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        timerDisplay.classList.add('hidden'); // Hide timer on results page
        quizContainer.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        
        // 'final-score' element is removed from HTML, so we remove the related reference and call to prevent TypeError
        const correctAnswersCountElement = document.getElementById('correct-answers-count');
        const finalPercentageElement = document.getElementById('final-percentage');
        
        // NEW: Set student name and class in the result card
        document.getElementById('display-student-name').textContent = studentName || 'අනාවරණය කර නැත';
        document.getElementById('display-student-class').textContent = studentClass || 'අනාවරණය කර නැත';

        const totalQuestions = quizData.length; // මුළු ප්‍රශ්න ගණන (10)
        const percentage = Math.round((score / totalQuestions) * 100);
        
        // Update the detailed score elements
        correctAnswersCountElement.textContent = `ඔබ ලබාගත් නිවැරදි පිළිතුරු: ${score} / ${totalQuestions}`;
        finalPercentageElement.textContent = `ලකුණු: ${percentage}%`;

        // Reset and set color class based on percentage for the percentage display
        finalPercentageElement.classList.remove('text-red-500', 'text-orange-500', 'text-lime-600', 'text-gray-700');

        // ලකුණු අනුව වර්ණය තීරණය කිරීම (Color determination based on score)
        if (percentage >= 70) {
            finalPercentageElement.classList.add('text-lime-600');
        } else if (percentage >= 40) {
            finalPercentageElement.classList.add('text-orange-500');
        } else {
            finalPercentageElement.classList.add('text-red-500');
        }
        
        // Update date/time for the captured card
        const date = new Date().toLocaleDateString('si-LK');
        const time = new Date().toLocaleTimeString('si-LK', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('result-date').textContent = `දිනය සහ වේලාව: ${date} | ${time}`;
        
        // Ensure the original final-score element is hidden (it was only used for simplicity before)
        // REMOVED: finalScoreElement.classList.add('hidden'); // This line caused the error
    }
    
    // --- Reset Quiz State and Show Start Screen ---
    function resetQuizState() {
        // Stop any running timer
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // Reset state variables
        currentQuestionIndex = 0;
        score = 0;
        isQuestionLocked = false;
        timeRemaining = TIME_LIMIT;
        
        // NEW: Clear student info and reset input fields
        studentName = '';
        studentClass = '';
        const nameInput = document.getElementById('student-name');
        const classInput = document.getElementById('student-class');
        if (nameInput) nameInput.value = '';
        if (classInput) classInput.value = '';
        document.getElementById('validation-message').classList.add('hidden');

        // Show the Start Screen and hide quiz/results/timer
        startScreen.classList.remove('hidden');
        quizContainer.classList.add('hidden');
        resultsContainer.classList.add('hidden');
        timerDisplay.classList.add('hidden');
        
        // Ensure modal is also hidden and animation class removed
        instructionModal.classList.add('hidden');
        modalContent.classList.remove('modal-enter-animation');
    }

    // ප්‍රශ්නාවලිය ආරම්භ කිරීමේ/නැවත ආරම්භ කිරීමේ කාර්යය
    function startQuiz() {
        // Validation is now handled in validateAndStartQuiz()
        
        // Reset the state to ensure a clean start, but keep the start screen hidden for now
        // NOTE: resetQuizState() is NOT called here as we only want to hide the screen, not clear the name/class info.
        
        startScreen.classList.add('hidden'); // Hide the start screen explicitly
        
        // ප්‍රශ්නාවලිය ආරම්භ කිරීමට පෙර ප්‍රශ්න අහඹු ලෙස පෙළගැස්වීම
        shuffleArray(quizData); 
        
        // Transition from Start Screen to Quiz Container
        quizContainer.classList.remove('hidden');
        timerDisplay.classList.remove('hidden');
        
        // Render the first question (Question 1)
        renderQuestion();
    }
    
    // --- 4. TAB CHANGE / WINDOW BLUR DETECTION (වෙනත් Tab එකකට ගියහොත් Reset කිරීම) ---
    document.addEventListener("visibilitychange", function() {
        // When the document is hidden (user switched to another tab/window)
        if (document.hidden) {
            // Only reset if the start screen is hidden, meaning the quiz is currently running or showing results
            if (startScreen.classList.contains('hidden')) {
                 resetQuizState();
            }
        }
    });

</script>
<script src="loading.js"></script>

</body>
</html>