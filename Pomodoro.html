<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer - අධ්‍යයන ටයිමරය</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styling and Fonts --- */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e8f5e9; /* Light Mint Green */
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #37474f; /* Dark text */
            transition: background-color 0.5s ease;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #ffffff;
            border-bottom: 1px solid #cfd8dc;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
            margin: 0;
            color: #1e88e5; /* Blue */
        }
        
        .header a {
            text-decoration: none;
            color: #1e88e5;
            font-size: 14px;
        }
        
        /* Simple Back Arrow Styling */
        .header .back-btn {
            font-size: 24px;
            cursor: pointer;
            visibility: hidden; /* Hidden by default in settings view */
            color: #1e88e5;
            text-decoration: none;
        }


        /* --- Main Content Area --- */
        .app-container {
            width: 90%;
            max-width: 450px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 80px; /* Space for fixed header */
        }

        /* --- View Management (Show/Hide) --- */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* --- Button Styling --- */
        .btn-primary {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-start {
            background-color: #1e88e5; /* Blue */
            color: white;
        }

        .btn-start:hover {
            background-color: #1565c0;
        }

        .btn-pause-resume {
            background-color: #ff9800; /* Orange */
            color: white;
            font-size: 20px;
            padding: 20px;
            width: 70%;
            max-width: 250px;
            display: block;
            margin: 30px auto 15px auto;
        }

        .btn-pause-resume:hover {
            background-color: #fb8c00;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #37474f;
            border: 1px solid #cfd8dc;
            padding: 10px 20px;
            margin-top: 10px;
            font-size: 14px;
            width: 100%;
        }

        /* --- Settings View (Image 1) --- */
        .settings-heading {
            text-align: center;
            font-size: 16px;
            margin-top: 0;
            font-weight: 400;
            color: #546e7a;
        }

        .slider-group {
            margin-bottom: 25px;
            padding: 10px 0;
            border-bottom: 1px solid #eceff1;
        }

        .slider-group label {
            display: block;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        /* Custom Slider Styling to match the image */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #1e88e5; /* Blue thumb */
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #78909c;
        }

        .current-value {
            font-weight: 700;
            color: #1e88e5;
            margin-top: 5px;
            text-align: center;
        }
        
        .info-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .info-link span {
            color: #1e88e5;
            cursor: pointer;
        }

        /* --- Timer View (Image 2) - Circular Progress Bar --- */
        .timer-display {
            text-align: center;
        }
        
        /* The container for the circular progress */
        .circular-timer {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 30px auto;
            border-radius: 50%;
            background: #e0e0e0; /* Gray border background */
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        /* The actual progress fill container */
        .timer-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            clip: rect(0, 250px, 250px, 125px); 
        }
        
        /* The right half of the progress bar */
        .timer-right, .timer-left {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #1e88e5; /* Default fill color (Blue) */
            transition: background 0.5s ease;
        }
        
        /* The right half (always visible up to 50%) */
        .timer-right {
            clip: rect(0, 125px, 250px, 0);
            transform: rotate(0deg);
        }

        /* The left half (visible after 50%) */
        .timer-left {
            clip: rect(0, 250px, 250px, 125px);
            transform: rotate(0deg);
            visibility: hidden; /* Hide left half initially */
        }

        /* The white mask that covers the fill to create the hollow effect */
        .timer-mask {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2; /* Place mask above the fills */
        }

        .time-remaining {
            font-size: 48px;
            font-weight: 700;
            color: #1e88e5;
        }

        .current-phase {
            font-size: 20px;
            font-weight: 500;
            margin-top: 20px;
            color: #37474f;
        }

        .cycle-info {
            font-size: 16px;
            color: #546e7a;
            margin-top: 5px;
        }

        .reset-link {
            display: block;
            margin-top: 15px;
            color: #ff9800; /* Orange reset text */
            text-decoration: none;
            font-weight: 500;
        }
        
        .reset-link:hover {
            text-decoration: underline;
        }
        
        .settings-button-wrapper {
            text-align: center;
            margin-top: 25px;
        }

    </style>
</head>
<body>
    <div class="header">
        <a href="#" class="back-btn" onclick="showView('settings')">&#8592;</a> <!-- Back Arrow -->
        <h1>Pomodoro Timer</h1>
        <a href="#" onclick="showAction('භාවිතා කරන ආකාරය')">How to Use</a>
    </div>

    <div class="app-container">
        
        <!-- ======================================================= -->
        <!-- View 1: Settings Interface (Image 1) -->
        <!-- ======================================================= -->
        <div id="settings-view" class="view active">
            
            <h2 class="settings-heading">ඔබට අවශ්‍ය ආකාරයට Timer Settings සකසන්න</h2>

            <!-- 1. Work Time Slider -->
            <div class="slider-group">
                <label for="work-time">වැඩ කරන වේලාව (Pomodoro):</label>
                <input type="range" id="work-time" min="15" max="60" step="1" value="25" oninput="updateSliderValue('work')">
                <div class="range-labels">
                    <span>15</span>
                    <span>30</span>
                    <span>45</span>
                    <span>60</span>
                </div>
                <div class="current-value"><span id="work-value">25</span> min</div>
            </div>

            <!-- 2. Short Break Slider -->
            <div class="slider-group">
                <label for="short-break">කෙටි විවේක වේලාව:</label>
                <input type="range" id="short-break" min="1" max="15" step="1" value="5" oninput="updateSliderValue('short')">
                <div class="range-labels">
                    <span>1</span>
                    <span>6</span>
                    <span>11</span>
                    <span>15</span>
                </div>
                <div class="current-value"><span id="short-value">5</span> min</div>
            </div>

            <!-- 3. Long Break Slider -->
            <div class="slider-group">
                <label for="long-break">දීර්ඝ විවේක වේලාව:</label>
                <input type="range" id="long-break" min="5" max="30" step="1" value="15" oninput="updateSliderValue('long')">
                <div class="range-labels">
                    <span>5</span>
                    <span>10</span>
                    <span>15</span>
                    <span>20</span>
                    <span>25</span>
                    <span>30</span>
                </div>
                <div class="current-value"><span id="long-value">15</span> min</div>
            </div>

            <!-- 4. Cycles Slider -->
            <div class="slider-group">
                <label for="cycles">වාර ගණන (Pomodoros):</label>
                <input type="range" id="cycles" min="1" max="10" step="1" value="4" oninput="updateSliderValue('cycles')">
                <div class="range-labels">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                    <span>8</span>
                    <span>9</span>
                    <span>10</span>
                </div>
                <div class="current-value"><span id="cycles-value">4</span></div>
            </div>

            <button class="btn-primary btn-start" onclick="startTimer()">Start</button>

            <div class="info-link">
                <span onclick="showAction('භාවිතා කරන ආකාරය පිළිබඳ උපදෙස්')">ℹ️ භාවිතා කරන ආකාරය</span>
            </div>
            
        </div>

        <!-- ======================================================= -->
        <!-- View 2: Timer Interface (Image 2) -->
        <!-- ======================================================= -->
        <div id="timer-view" class="view">
            <div class="timer-display">
                
                <div class="circular-timer">
                    <!-- Progress Bar Components -->
                    <div id="timer-fill" class="timer-fill">
                        <div id="timer-right" class="timer-right"></div>
                        <div id="timer-left" class="timer-left"></div>
                    </div>
                    
                    <div class="timer-mask">
                        <span id="time-remaining" class="time-remaining">00:00</span>
                    </div>
                </div>

                <div id="current-phase" class="current-phase">වැඩ කරන වේලාව</div>
                <div id="cycle-info" class="cycle-info">Cycle 1 of 4</div>
                
                <button id="pause-resume-btn" class="btn-pause-resume" onclick="pauseResumeTimer()">නවත්තන්න</button>
                
                <a href="#" class="reset-link" onclick="resetTimer()">Reset</a>
                
                <div class="settings-button-wrapper">
                    <button class="btn-secondary" onclick="showView('settings')">⚙️ Timer Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State Variables ---
        let timerInterval = null;
        let isRunning = false;
        let totalSeconds = 0;
        let secondsRemaining = 0;

        // Default Settings (will be updated by sliders on load)
        let workTimeMinutes = 25;
        let shortBreakMinutes = 5;
        let longBreakMinutes = 15;
        let totalCycles = 4;
        
        // Timer Logic State
        let currentPhaseIndex = 0; // Tracks position in the phaseSequence array
        let currentCycle = 1;

        // Sequence of phases (W=Work, S=Short Break, L=Long Break)
        const phaseSequence = []; 

        /**
         * Initializes the phase sequence (e.g., W, S, W, S, W, S, W, L) based on user cycles.
         */
        function initializePhaseSequence() {
            phaseSequence.length = 0;
            const cycles = totalCycles; // Use the globally updated variable
            
            for (let i = 0; i < cycles; i++) {
                phaseSequence.push('W'); // Add Work Session

                if (i < cycles - 1) {
                    // Not the last work session: Add Short Break
                    phaseSequence.push('S');
                } else if (cycles > 1) {
                    // Last work session (and total cycles > 1): Add Long Break
                    phaseSequence.push('L');
                }
            }
            console.log("Initialized Phase Sequence:", phaseSequence.join(', '));
        }
        
        /**
         * Switches the active view.
         * @param {string} viewId - The ID of the view to show ('settings' or 'timer').
         */
        function showView(viewId) {
            document.getElementById('settings-view').classList.remove('active');
            document.getElementById('timer-view').classList.remove('active');
            document.getElementById(viewId + '-view').classList.add('active');
            
            // Update the back arrow visibility
            const headerArrow = document.querySelector('.header .back-btn');
            if (viewId === 'settings') {
                headerArrow.style.visibility = 'hidden';
                // If user goes back to settings while running, pause the timer
                if (isRunning) { 
                     pauseResumeTimer(); 
                }
            } else {
                 headerArrow.style.visibility = 'visible';
            }
            
            // Update the body background color based on the view/phase
            updateBodyBackground(viewId);
        }

        /**
         * Updates the displayed value next to the corresponding slider and updates global variables.
         * FIX: Correctly maps slider types to HTML element IDs.
         * @param {string} type - 'work', 'short', 'long', or 'cycles'.
         */
        function updateSliderValue(type) {
            let sliderId;
            // Correctly map type to actual HTML ID
            if (type === 'work') sliderId = 'work-time';
            else if (type === 'short') sliderId = 'short-break'; // **FIXED ID**
            else if (type === 'long') sliderId = 'long-break';   // **FIXED ID**
            else if (type === 'cycles') sliderId = 'cycles';
            else return; 

            const slider = document.getElementById(sliderId);
            const valueSpan = document.getElementById(`${type}-value`);
            
            if (slider && valueSpan) {
                const value = parseInt(slider.value);
                valueSpan.textContent = value;
                
                // Update global settings variables
                if (type === 'work') workTimeMinutes = value;
                if (type === 'short') shortBreakMinutes = value;
                if (type === 'long') longBreakMinutes = value;
                if (type === 'cycles') totalCycles = value;
            }
        }

        /**
         * Plays a simple beep sound using the Web Audio API.
         */
        function playSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine';
                // Start Sound: High pitch for 0.15s
                oscillator.frequency.setValueAtTime(660, audioContext.currentTime); 
                gainNode.gain.setValueAtTime(0.7, audioContext.currentTime);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.15); 
            } catch (e) {
                console.error("Audio playback failed:", e);
                // Fallback for environments where AudioContext might be restricted
                // Using an alert as a last resort, as per previous instructions to avoid alert()
                // In a real scenario, this would be a custom modal.
                console.log("Time's up sound skipped."); 
            }
        }

        /**
         * Calculates the duration, updates the UI text, and sets the body background color for the current phase.
         */
        function setupPhase() {
            if (currentPhaseIndex >= phaseSequence.length) {
                console.log("All phases completed.");
                return;
            }

            const currentPhaseType = phaseSequence[currentPhaseIndex];
            let durationMinutes = 0;
            let phaseName = "";
            let progressColor = "";
            let bgColor = "";
            
            // Calculate the current Pomodoro cycle number
            const workPhasesDone = phaseSequence.slice(0, currentPhaseIndex).filter(p => p === 'W').length;
            currentCycle = workPhasesDone + 1;

            // Determine duration, name, color based on the current phase type
            if (currentPhaseType === 'W') {
                durationMinutes = workTimeMinutes;
                phaseName = "වැඩ කරන වේලාව (Pomodoro)"; 
                progressColor = '#1e88e5'; // Blue
                bgColor = '#e3f2fd'; // Light Blue
            } else if (currentPhaseType === 'S') {
                durationMinutes = shortBreakMinutes;
                phaseName = "කෙටි විවේක වේලාව"; 
                progressColor = '#ff9800'; // Orange
                bgColor = '#fff3e0'; // Light Orange/Yellow
            } else if (currentPhaseType === 'L') {
                durationMinutes = longBreakMinutes;
                phaseName = "දීර්ඝ විවේක වේලාව"; 
                progressColor = '#4caf50'; // Green
                bgColor = '#e8f5e9'; // Light Green
            }

            secondsRemaining = durationMinutes * 60;
            totalSeconds = secondsRemaining;
            
            // Update UI elements for the new phase
            document.getElementById('current-phase').textContent = phaseName;
            
            // Update cycle info display
            if (currentPhaseType === 'W') {
                 document.getElementById('cycle-info').textContent = `Cycle ${currentCycle} of ${totalCycles}`;
            } else {
                 // For breaks, show progress towards the total cycle count
                 document.getElementById('cycle-info').textContent = `Getting ready for Pomodoro ${currentCycle}`;
            }
           
            // Update Colors
            document.body.style.backgroundColor = bgColor;
            document.getElementById('timer-right').style.background = progressColor;
            document.getElementById('timer-left').style.background = progressColor;
            document.querySelector('.time-remaining').style.color = progressColor;

            
            updateDisplay();
            updateProgress(1); // Start progress bar at 100% (1 remaining)
        }
        
        /**
         * Updates the body background color based on the current view.
         */
        function updateBodyBackground(viewId) {
            if (viewId === 'settings') {
                document.body.style.backgroundColor = '#e8f5e9'; // Light Mint Green
            } else {
                 setupPhase(); // Re-run setup to apply phase-specific colors
            }
        }

        /**
         * Starts or continues the timer.
         */
        function startTimer() {
            // Prevent multiple intervals from running
            if (isRunning) return;
            
            // 1. Initial Setup on first run (or after Reset)
            if (timerInterval === null && currentPhaseIndex === 0) {
                initializePhaseSequence();
                setupPhase();
            }

            // Check if all cycles are complete
            if (currentPhaseIndex >= phaseSequence.length) {
                // If timer finished, reset to restart
                resetTimer(); 
                startTimer();
                return;
            }

            // 2. Play sound and transition view
            playSound();
            showView('timer');
            
            // 3. Start timer
            isRunning = true;
            document.getElementById('pause-resume-btn').textContent = 'නවත්තන්න';
            
            timerInterval = setInterval(() => {
                secondsRemaining--;
                
                updateDisplay();
                updateProgress(secondsRemaining / totalSeconds);

                if (secondsRemaining <= 0) {
                    // Phase is complete
                    clearInterval(timerInterval);
                    timerInterval = null;
                    isRunning = false;
                    playSound(); // Play sound for phase completion
                    
                    currentPhaseIndex++; // Move to the next phase
                    
                    if (currentPhaseIndex < phaseSequence.length) {
                        // Start next phase automatically
                        setupPhase();
                        startTimer();
                    } else {
                        // All cycles complete
                        document.getElementById('current-phase').textContent = '✅ සම්පූර්ණයි!';
                        document.getElementById('cycle-info').textContent = 'සියලු වාර සම්පූර්ණයි.';
                        document.getElementById('pause-resume-btn').textContent = 'Reset'; // Suggest Reset
                        document.getElementById('pause-resume-btn').onclick = resetTimer;
                        // Use a custom alert message
                        showAction('සියලුම අධ්‍යයන වාරයන් අවසන් කර ඇත! Reset ඔබා නැවත ආරම්භ කරන්න.');
                    }
                }
            }, 1000); // Ticks every second
        }

        /**
         * Pauses or Resumes the timer.
         */
        function pauseResumeTimer() {
            if (isRunning) {
                // Pause
                clearInterval(timerInterval);
                timerInterval = null;
                isRunning = false;
                document.getElementById('pause-resume-btn').textContent = 'ආරම්භ කරන්න';
            } else {
                // Resume
                startTimer();
            }
        }

        /**
         * Resets the timer to the initial state (Settings View).
         */
        function resetTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            isRunning = false;
            
            // Reset state variables
            currentPhaseIndex = 0;
            currentCycle = 1;

            // Re-read settings for clean start
            updateSliderValue('work');
            updateSliderValue('short');
            updateSliderValue('long');
            updateSliderValue('cycles');
            
            initializePhaseSequence();
            setupPhase(); // Initialize the first phase (Work)
            
            document.getElementById('pause-resume-btn').textContent = 'ආරම්භ කරන්න';
            document.getElementById('pause-resume-btn').onclick = startTimer;
            
            showView('settings'); // Go back to settings view
        }

        /**
         * Updates the time remaining display (MM:SS).
         */
        function updateDisplay() {
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('time-remaining').textContent = display;
        }

        /**
         * Updates the circular progress bar rotation.
         * @param {number} percentage - The percentage of time remaining (0.0 to 1.0).
         */
        function updateProgress(percentage) {
            // Angle of completion (0 to 360)
            const angle = 360 * (1 - percentage); 
            const rightHalf = document.getElementById('timer-right');
            const leftHalf = document.getElementById('timer-left');

            // The timer works by rotating two half-circles:
            // 1. Right Half rotates from 0 to 180 degrees (0% to 50% completion)
            // 2. Left Half rotates from 0 to 180 degrees (50% to 100% completion)

            if (angle <= 180) {
                // First half completion
                rightHalf.style.transform = `rotate(${angle}deg)`;
                leftHalf.style.visibility = 'hidden';
            } else {
                // Second half completion
                rightHalf.style.transform = `rotate(180deg)`; // Right side is fully covered
                leftHalf.style.transform = `rotate(${angle - 180}deg)`;
                leftHalf.style.visibility = 'visible';
            }
        }

        /**
         * Shows a simulated action alert for instructional links or end message.
         */
        function showAction(message) {
            // Using console.log instead of alert for better user experience in the environment
            console.log(`Action/Instruction: ${message}`); 
            // If you wish to show a UI message, replace this with a custom modal function.
            const customAlert = document.getElementById('custom-alert') || document.createElement('div');
            customAlert.id = 'custom-alert';
            customAlert.textContent = message;
            customAlert.style = `
                position: fixed; top: 10px; right: 10px; 
                background: #4caf50; color: white; padding: 15px; 
                border-radius: 8px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                opacity: 1; transition: opacity 0.5s;
            `;
            document.body.appendChild(customAlert);
            setTimeout(() => {
                customAlert.style.opacity = 0;
            }, 3000);
            setTimeout(() => {
                 customAlert.remove();
            }, 3500);
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize slider values on load (FIXED the bug here)
            updateSliderValue('work');
            updateSliderValue('short');
            updateSliderValue('long');
            updateSliderValue('cycles');
            
            // 2. Set initial timer state
            initializePhaseSequence();
            setupPhase();
            
            // 3. Start the view on settings
            showView('settings');
        });

    </script>
</body>
</html>
